EXPLORING RED WINE DATA by Jesus Fandino
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

library(ggplot2)
library(GGally)
library(gridExtra)
library(RColorBrewer)
library(corrplot)
library(plyr)
```

```{r echo=FALSE, Load_the_Data}
# Load the Data
wine_red <- read.csv("wineQualityReds.csv")
wine_red$X <- NULL
```

# Univariate Plots Section
```{r echo=FALSE, Univariate_Plots}
plt1.0 <- ggplot(wine_red, aes(x = fixed.acidity)) +
  geom_histogram(binwidth = 0.3) 

plt1.1 <- ggplot(wine_red, aes(x = volatile.acidity)) +
  geom_histogram(binwidth = 0.02) 

plt1.2 <- ggplot(wine_red, aes(x = citric.acid)) +
  geom_histogram(binwidth = 0.02) 

plt1.3 <- ggplot(wine_red, aes(x = residual.sugar)) +
  geom_histogram(binwidth = 0.2)

plt1.4 <- ggplot(wine_red, aes(x = chlorides)) +
  geom_histogram(binwidth = 0.008) 

plt1.5 <- ggplot(wine_red, aes(x = free.sulfur.dioxide)) +
  geom_histogram(binwidth = 3) 

plt1.6 <- ggplot(wine_red, aes(x = total.sulfur.dioxide)) +
  geom_histogram(binwidth = 3) 

plt1.7 <- ggplot(wine_red, aes(x = density)) +
  geom_histogram(binwidth = 0.0004) 

plt1.8 <- ggplot(wine_red, aes(x = pH)) +
  geom_histogram(binwidth = 0.03)

plt1.9 <- ggplot(wine_red, aes(x = sulphates)) +
  geom_histogram(binwidth = 0.03) 

plt1.10 <- ggplot(wine_red, aes(x = alcohol)) +
  geom_histogram(binwidth = 0.2) 

plt1.11 <- ggplot(wine_red, aes(x = quality)) +
  geom_histogram(binwidth = 1) 

grid.arrange(plt1.0, plt1.1, plt1.2, plt1.3, plt1.4, plt1.5, plt1.6, plt1.7, plt1.8, plt1.9, plt1.10, plt1.11, 
             ncol=4)

```

Some observations:

- Density and pH appear to be normally distributed. 

- The distribution of fixed acidity is unimodal and appears positively skewed.  In the case of volatile acidity, it looks like bimodal.

- The concentration of citric acid naturally found in wine is small. As it is a fixed acid, we did not expect a column specifically devoted to it, unless certain amounts of citric acid were intentionally added to the samples at some point in the fabrication process. This assupmtion is consistent with the high count of samples with no citric acid. 

- The distribution of residual sugar and chlorides in the samples have long positive tails with outliers. Residual sugar is correlated with sweetness.

- Although quality varies between zero and ten, the dataset provides samples with qualities between 3 and 8. The distribution appears to be normal, and most of the samples have  quality equal to 5 or 6. 

# Univariate Analysis

### What is the structure of your dataset?
In this work, we used a dataset of a red wine (Vinho Verde) from Portugal, that contained information on almost 1600 samples. This dataset was first employed by Cortez et al. [1] in 2009 and is available for free. 

 Variables and Units (Unmodified dataset).
 
- X: whole number, unique for each observation (Removed).

- fixed.acidity: non-volatile acids found in wines, the most common are tartaric, malic, citric and succinic (as tartaric acid in g/L).

- volatile.acidity: largely acetic acid, linked to the vinegary taste (as acetic acid in g/L).

- citric.acid: found in small quantities, typically 1/20 of the tartaric acid concentrations (in g/L).

- residual.sugar: the sugar that remains in wine after fermentation completes (in g/L).

- chlorides: the amount of salt (as sodium chloride in g/L)

- free.sulfur.dioxide: SO2 [molecular] + HSO3 [bisulfites] + SO3 [sulfites]. It is the buffer against microbes and oxidation (in mg/L)

- total.sulfur.dioxide: free sulfur dioxide + bound sulfur dioxide [sulfites attached to either sugars, acetaldehyde or phenolic compounds] (in mg/L)

- density: mass divided by volume, the density of wines are close to that of water (in g/cm3)

- pH: -log10 of the activity of the hydrogen ion, it ranges from 0 to 14. (Zero is the most acidic, 7 is neutral, and 14 is the most basic); pH values for wines are typically between 3 and 4.

- sulphates: The concentration of sulfates. Sulfur dioxide, upon oxidation, is converted into sulfate (as potassium sulfate in g/L)

- alcohol: the amount of alcohol in % vol. For wines, it varies in a wide range, between 5.5% (Moscato dâ€™Asti ) up to 21% (fortified wines).

- quality:  a whole number to qualify the wine. It ranges from zero (bad) to ten (excellent), it is a subjective measure. For this dataset, it was the median of a blind testing of at least three different experts for each sample. 

```{r, echo=FALSE, Structure}
str(wine_red)
```
```{r, echo=FALSE, Summary}
summary(wine_red)
```
### What is/are the main feature(s) of interest in your dataset?

The most noticeable variable in this dataset is the quality of the wine. That is a unique feature because it is the only one that does not come directly from an instrument or a mathematical derivation of a direct measurement. So far we depend on human experts to assign a quality number to a wine. For that reason, any way to correlate 'objective' variables with quality might contribute to our understanding of what makes a wine bad or good.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

It appears that volatile acidity and alcohol content are the variables with the strongest correlation to quality.   We are going to follow them closely, but also we are going to investigate most of the variables in our dataset.

### Did you create any new variables from existing variables in the dataset?

Immediately after loading the .csv file, we deleted X (we did not find a proper use for it)

After creating the correlation matrix (that required only numerical variables),  we proceeded to convert quality to a factor variable. 

At that point, we also created three more ordered categorical variables using existing variables:

- quality.level, with four levels: "Low" for quality equal to 3 and 4, "Medium Low" for quality equals 5, "Medium" for quality equals 6 and "High" for quality equals 7 and 8.

- alcohol.level, with three levels: "Low Alcohol" for alcohol content below or equal to 10 % vol., "Medium Alcohol" for alcohol content higher than 10 % vol and less than or equal to 11.5 % vol. and "High Alcohol" for alcohol contents greater than 11.5 % vol.

- SO2.level, with three levels: "Low  SO2" for values of 'total.sulfur.dioxide' below one standard deviation (std) to the left of the mean, "Medium SO2" for values within one std of the mean, and "High SO2" for values in excess one std to the right of the mean.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

The histogram for the variable 'citric.acid' was unexpected. There are some sharp peaks, that would be caused by the addition of certain preferred amounts of citric acid to the samples (including not adding citric acid at all). 
Other than to create new variables, as mentioned above, we did not modify the existing data in any way.

```{r echo=FALSE, Correlation_Matrix}
corr_mat <- cor(wine_red)
#corr_mat
```


# Bivariate Plots Section
```{r echo=FALSE, Bivariate_Plots}
corrplot(corr_mat)
```

There are some strong correlations in the data:

a) pH and fixed acidity (Negative). Acid pH values are located in the lower part of the scale (pH < 7).

b) citric acid and fixed acidity (Positive). Citric acid is a fixed acid.

c) fixed acidity and density (Positive). Fixed organic acids are denser than water

d) total sulfur dioxide and free sulfur dioxide (Positive). Free sulfur dioxide is a subset of total sulfur dioxide.

e) citric acid and volatile acidity (Negative). Surprising, since the citric-sugar co-metabolism can increase the formation of volatile acid in wine.

f) pH and citric acid (Negative). Citric acid is a fixed acid (same as in a)

g) alcohol and density (Negative). Alcohol is less dense than water

f) alcohol and quality (Positive). Subjective


```{r echo=FALSE, New_Variables}
wine_red$quality.level <- cut(wine_red$quality,
                              breaks = c(-Inf, 5, 6, 7, Inf),
                              labels =c("Low", "Medium Low", "Medium", "High"),
                              right = FALSE)
wine_red$quality.level <- ordered(wine_red$quality.level, levels= c("Low", "Medium Low", "Medium", "High"))
wine_red$alcohol.level <- cut(wine_red$alcohol, 
                              breaks = c(-Inf, 10.1, 11.6, Inf),
                              labels = c("Low Alcohol", "Medium Alcohol", "High Alcohol"),
                              right = FALSE)
wine_red$alcohol.level <- ordered(wine_red$alcohol.level, levels= c("Low Alcohol", "Medium Alcohol", "High Alcohol"))

wine_red$quality <- as.factor(wine_red$quality)

sd_total_sulf <- sd(wine_red$total.sulfur.dioxide)
mean_total_sulf <- mean(wine_red$total.sulfur.dioxide)
low_lim <- round(mean_total_sulf - sd_total_sulf, digits = 0)
up_lim <- round(mean_total_sulf + sd_total_sulf, digits = 0)

wine_red$SO2.level <- cut(wine_red$total.sulfur.dioxide, 
                              breaks = c(-Inf, 15, 80, Inf),
                              labels = c("Low SO2", "Medium SO2", "High SO2"),
                              right = FALSE)
wine_red$SO2.level <- ordered(wine_red$SO2.level, levels= c("Low SO2", "Medium SO2", "High SO2"))

```

```{r echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots_02}
fill <- "olivedrab2"
line <- "#1F3552"

plt2.1 <- ggplot( wine_red, aes(x = quality, y = citric.acid)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE)

plt2.2 <- ggplot( wine_red, aes(x = quality, y = volatile.acidity)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE)

plt2.3 <- ggplot( wine_red, aes(x = quality, y = sulphates)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE)

plt2.4 <- ggplot( wine_red, aes(x = quality, y = density)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE)

grid.arrange(plt2.1, plt2.2, plt2.3, plt2.4, ncol = 2)

plt2.5 <- ggplot( wine_red, aes(x = quality, y = fixed.acidity)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE)

plt2.6 <- ggplot( wine_red, aes(x = quality, y = total.sulfur.dioxide)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE) +
  ylim(0, 175) +
  annotate("text", x = 4, y = 175, label = "Not all outliers shown")

plt2.7 <- ggplot( wine_red, aes(x = quality, y = alcohol)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE)

plt2.8 <- ggplot( wine_red, aes(x = quality, y = chlorides)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE) +
  coord_cartesian(ylim = c(0, 0.2)) +
  annotate("text", x = 3, y = 0.01, label = "Not all outliers shown")

grid.arrange(plt2.5, plt2.6, plt2.7, plt2.8, ncol = 2)
```

So far, we can argue (according to our results), that human taste correlates high alcohol content with high-quality wines.  
Chlorides and fixed acidity do not show any clear trend with quality level. Meanwhile, total sulfur dioxide seems to peak at quality equal to 5.
The highest percentage of outliers belongs to levels 5 and 6. 

```{r echo=FALSE, Bivariate_Plots_03, message=FALSE, warning=FALSE}
fill <- "#df1b73"
line <- "#1F2132"

plt2.9 <- ggplot( wine_red, aes(x = alcohol.level, y = density)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE) +
  labs(x = "")


plt2.10 <- ggplot( wine_red, aes(x = alcohol.level, y = volatile.acidity)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = TRUE) +
  labs(x = "")


plt2.11 <- ggplot( wine_red, aes(x = alcohol.level, y = pH)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE) +
  labs(x = "")


plt2.12 <- ggplot( wine_red, aes(x = alcohol.level, y = sulphates)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE) +
  labs(x = "")

grid.arrange(plt2.9, plt2.10, plt2.11, plt2.12, ncol = 2)

plt2.13 <- ggplot( wine_red, aes(x = alcohol.level, y = chlorides)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = FALSE) +
  ylim(0, 0.2) +
  annotate("text", x = "Medium Alcohol", y = 0.20, label = "Not all outliers shown") +
  labs(x = "")

plt2.14 <- ggplot( wine_red, aes(x = alcohol.level, y = citric.acid)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = TRUE) +
  labs(x = "")

grid.arrange(plt2.13, plt2.14, ncol = 2)
```

The decrease in the median value of density is expected as the alcohol level goes up. The detail that could be a little more intriguing is why the interquartile range of density seems to increase for higher alcohol contents. 
In relation to pH values, water and alcohol are close, probably that reason helps to explain why the changes in pH are irrelevant.
Low alcohol level samples tend to display more outliers than the rest (particularly in the cases of sulfates and chlorides). What does it mean?

```{r echo=FALSE, Bivariate_Plots_04}
fill <- "#ff6f00"
line <- "#1F2132"
plt2.15 <- ggplot( wine_red, aes(x = SO2.level, y = density)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = TRUE) +
  labs(x = "")
plt2.16 <- ggplot( wine_red, aes(x = SO2.level, y = volatile.acidity)) + 
  geom_boxplot(fill = fill, colour = line, size = 0.2, notch = TRUE) +
  labs(x = "")
grid.arrange(plt2.15, plt2.16, ncol = 2)
```

The median values of volatile acidity increasing with SO2 levels was an unexpected outcome. However, we found that concerning the acetic acid content, the taste of wine starts becoming unpleasant at concentrations greater than 1.2 g/L. According to the picture above, that represents just a few samples in our dataset. Below that limit, winemakers usually change the values of volatile acidity pursuing the desired flavor.

```{r echo=FALSE, Bivariate_Plots_05 }

cor_val12 <- cor.test(wine_red$density, wine_red$fixed.acidity)$estimate
textlab12 <- paste(round(cor_val12, digits = 3))

plt2.12 <- ggplot(wine_red, aes(x = fixed.acidity, y = density)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  annotate("text", x = 12, y = 0.992, label = textlab12)

cor_val13 <- cor.test(wine_red$pH, wine_red$fixed.acidity)$estimate
textlab13 <- paste(round(cor_val13, digits = 3))

plt2.13 <- ggplot(wine_red, aes(x = fixed.acidity, y = pH)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  annotate("text", x = 12, y = 3.7, label = textlab13)

cor_val14 <- cor.test(wine_red$citric.acid, wine_red$fixed.acidity)$estimate
textlab14 <- paste(round(cor_val14, digits = 3))

plt2.14 <- ggplot(wine_red, aes(x = fixed.acidity, y = citric.acid)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  annotate("text", x = 13, y = 0.1, label = textlab14)

wine995 <-wine_red[wine_red$total.sulfur.dioxide < quantile(wine_red$total.sulfur.dioxide, 0.995),]

cor_val16 <- cor.test(wine995$free.sulfur.dioxide, wine995$total.sulfur.dioxide)$estimate
textlab16 <- paste(round(cor_val16, digits = 3))

plt2.16 <- ggplot(wine995, aes(x = total.sulfur.dioxide, y = free.sulfur.dioxide)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm") +
  scale_color_brewer(type = 'qual', palette = 6) +
  annotate("text", x = 40, y = 60, label = textlab16)

grid.arrange(plt2.13, plt2.14, plt2.12, plt2.16, ncol= 2)
```

Those four graphs display the strongest correlations among our variables. We are going to dig deeper into them, searching for any hidden dependency on quality.
In the case of free sulfur dioxide vs total sulfur dioxide we removed the top 0.5 % of the total sulfur dioxide data (two outliers) from the plot.

```{r echo=FALSE, Bivariate_Plots_06}
ggplot(wine_red, aes(x = quality, fill = alcohol.level)) + 
  geom_bar(position = "fill") +
  labs(y = "Normalized Count") +
  theme_bw()

ggplot(wine_red, aes(x = quality, fill = alcohol.level)) + 
  geom_bar(position = "dodge") +
  theme_bw()
```

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

As an average, as quality goes from 3 up to 8,  the concentrations of citric acid, sulfates and alcohol increase. Volatile acidity, density, pH (not shown), and chlorides showed the opposite trend; they decrease as quality goes up.  Total sulfur dioxide peaks at 5 and then decreases. Residual sugar (not shown) did not change appreciably within the quality range.

Variations in some variables across alcohol levels are, in general, less sharp than in the case of quality. We observed a slight average increase in the concentration of citric acid and sulfates as alcohol levels go up. Meanwhile, density, volatile acidity and chlorides dropped in the same interval of alcohol levels. 

The changes were even harder to observe in the case of total sulfur dioxide levels (SO2.levels). In that case, a modest increase in the average value of density was observed as SO2 levels moved from low to high.


### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

As expected, pH values went down as acidity increased, meanwhile density and alcohol display opposite trends.  However, the volatile acidity tends to increase as SO2 levels go from low to high. That is counterintuitive, since one the multiple uses of sulfur dioxide is to inhibit the proliferation of the bacteria responsible for acetic acid production. 

### What was the strongest relationship you found?

We found a total of four relationships that were almost equally strong. The strongest among them was between pH and fixed acidity (Pearson's correlation factor -0.683, that  increases further if we take log10(fixed.acidity)). That high value of the correlation coefficient is expected as both magnitudes are related to the Chemistry of acid dissociation in the context of acid-base reactions. Fixed acidity also generates strong relationships with citric acid and density, as shown. Also, total sulfur dioxide and free sulfur dioxide are highly correlated. 

```{r echo=FALSE, Functions}
# Calculate the correlation coefficients and build a dataframe, ready to plot with geom_text() 
corr_df <- function (dfm, x0, y0, col1, col2, facet_col="alcohol.level") {
  coeff <- c()
  x <-c()
  y <-c()
  for (l in levels(dfm[[facet_col]])) {
  coeff <- c(coeff, cor.test(dfm[dfm[facet_col]== l,][[col1]], dfm[dfm[facet_col]== l,][[col2]])$estimate[[1]])
  x <- c(x, x0)
  y <- c(y, y0)
  }
  coeff <- paste(round(coeff, digits = 3))
  dat <- data.frame(x, y, facet_col=levels(dfm[[facet_col]]), labs = coeff)
  colnames(dat)[3] <- facet_col
  return(dat)
}

# Calculate the number of samples for faceted data, ready to plot with geom_text()
# Requires library(plyr)
nsamples_df <- function (df, x0, y0, facet1, facet2=c(NULL)) {
  x <-c()
  y <- c()
  f1 <-levels(df[[facet1]])
  
  if (is.null(facet2)) {
    f2 <- 1
    vars <- ddply(df, c(facet1), summarize, count = length(quality))
  } else {
    f2 <-levels(df[[facet2]])
    vars <- ddply(df, c(facet1, facet2), summarize, count = length(quality))
  }
  
  r <- length(f1) * length(f2)
  x <- rep(x0, r)
  y <- rep(y0, r)  
  
  vars$count <- paste("N =", vars$count)
  dat <- data.frame(x, y, vars)
  
  return(dat)
}
```    

# Multivariate Plots Section

```{r echo=FALSE, Multivariate_Plots_01}
# Calculating correlation coefficients between fixed.acidity and pH for different quality levels
dat <- corr_df(wine_red, 12, 3.7, "fixed.acidity", "pH", "quality.level")

ggplot(wine_red, aes(x = fixed.acidity, y = pH)) +
  geom_point(alpha = 0.5, aes(color = alcohol.level)) +
  geom_smooth(method = "lm") +
  facet_wrap(~ quality.level) +
  theme_bw() +
  geom_text(aes(x, y, label=labs, group=NULL),data=dat) +
  ggtitle(" pH vs Fixed Acidity for different Quality levels")

# Calculating correlation coefficients between fixed.acidity and citric.acid for different quality levels
dat <- corr_df(wine_red, 14, 0.15, "fixed.acidity", "citric.acid", "quality.level")

ggplot(wine_red, aes(x = fixed.acidity, y = citric.acid)) +
  geom_point(alpha = 0.5, aes(color = alcohol.level)) +
  geom_smooth(method = "lm") +
  facet_wrap(~ quality.level) +
  theme_bw() +
  geom_text(aes(x, y, label=labs, group=NULL),data=dat) +
  ggtitle(" Citric Acid vs Fixed Acidity for different Quality levels")

# Calculating correlation coefficients between fixed.acidity and density for different quality levels
dat <- corr_df(wine_red, 14, 0.994, "fixed.acidity", "density", "quality.level")

ggplot(wine_red, aes(x = fixed.acidity, y = density)) +
  geom_point(alpha = 0.5, aes(color = alcohol.level)) +
  geom_smooth(method = "lm") +
  facet_wrap(~ quality.level) +
  theme_bw() +
  geom_text(aes(x, y, label=labs, group=NULL),data=dat) +
  ggtitle(" Density vs Fixed Acidity for different Quality levels")


# Calculating correlation coefficients between total sulfur dioxide and free sulfur dioxide for different quality levels
dat <- corr_df(wine995, 40, 60, "total.sulfur.dioxide", "free.sulfur.dioxide", "quality.level")

ggplot(wine995, aes(x = total.sulfur.dioxide, y = free.sulfur.dioxide)) +
  geom_point(alpha = 0.5, aes(color = alcohol.level)) +
  geom_smooth(method = "lm") +
  facet_wrap(~ quality.level) +
  theme_bw() +
  geom_text(aes(x, y, label=labs, group=NULL),data=dat) +
  ggtitle(" Free Sulfur Dioxide vs Total Sulfur Dioxide for different Quality levels")

```

There is a general reduction of the scattering as the quality level rises in the four plots. That could be related to a more restricted change interval for the given variables as quality improves (i.e. maybe a change of 0.5 pH units for a given fixed acidity in some regions still produces a "Medium Low" quality wine but not a "High" quality one). 
The data points belonging to different quality levels are mixed in a way that with the aid of the variables plotted, we were not able to identify "regions" of given qualities.

```{r echo=FALSE, Multivariate_Plots_02}
# pH vs Fixed Acidity for different alcohol levels
dat <- corr_df(wine_red, 12, 3.7, "fixed.acidity", "pH")

ggplot(wine_red, aes(x = fixed.acidity, y = pH)) +
  geom_point(alpha = 0.5, aes(color= quality.level)) +
  geom_smooth(method = "lm") +
  scale_color_brewer(type = 'qual', palette = 6) +
  facet_wrap(~ alcohol.level) +
  geom_text(aes(x, y, label=labs, group=NULL),data=dat) 

# Citric Acid vs Fixed Acidity for different alcohol levels
dat <- corr_df(wine_red, 14, 0.15, "fixed.acidity", "citric.acid")

ggplot(wine_red, aes(x = fixed.acidity, y = citric.acid)) +
  geom_point(alpha = 0.5, aes(color= quality.level)) +
  geom_smooth(method = "lm") +
  scale_color_brewer(type = 'qual', palette = 6) +
  facet_wrap(~ alcohol.level) +
  geom_text(aes(x, y, label=labs, group=NULL),data=dat) 

# Density vs Fixed Acidity for different alcohol levels
dat <- corr_df(wine_red, 14, 0.994, "fixed.acidity", "density")

ggplot(wine_red, aes(x = fixed.acidity, y = density)) +
  geom_point(alpha = 0.5, aes(color= quality.level)) +
  geom_smooth(method = "lm") +
  scale_color_brewer(type = 'qual', palette = 6) +
  facet_wrap(~ alcohol.level) +
  geom_text(aes(x, y, label=labs, group=NULL),data=dat) 

# Free sulfur dioxide vs Total sulfur dioxide for different alcohol levels
dat <- corr_df(wine995, 40, 60, "total.sulfur.dioxide", "free.sulfur.dioxide")

ggplot(wine995, aes(x = total.sulfur.dioxide, y = free.sulfur.dioxide)) +
  geom_point(alpha = 0.5, aes(color= quality.level)) +
  geom_smooth(method = "lm") +
  scale_color_brewer(type = 'qual', palette = 6) +
  facet_wrap(~ alcohol.level) +
  geom_text(aes(x, y, label=labs, group=NULL),data=dat) 

```

The same four combinations of variables, now faceted by alcohol level, produced a result similar to the one previously shown for quality levels (correlation coefficient increases from low to high alcohol levels). Also, a quick look at the quality composition by alcohol level reveals that "Medium Low" quality samples dominate at low alcohol, "Medium" quality does it at "Medium Alcohol" and the "High Alcohol" level is almost exclusively populated by medium and high-quality samples. All of this adds support to the strong connection between quality and alcohol.

```{r echo=FALSE, warning=FALSE, Multivariate_Plots_03}
median01 = median(wine_red$alcohol)
median02 = median(wine_red$density)  

ggplot( wine_red, aes(x = alcohol, y = density)) + 
  geom_point(alpha = 0.4, aes(color = quality.level), size = 2) +
  scale_color_brewer(type = 'qual', palette = 6) +
  labs(x = "Alcohol (%vol)", y = "Density (g/cm3)") +
  theme_bw() +
  geom_hline(yintercept= median02, linetype="dashed", color='black', size=0.3) +
  geom_vline(xintercept=median01, linetype="dashed", color='black', size=0.3)


# Create lines for the median values of density and alcohol
y.meds <- ddply(wine_red, .(quality.level), summarize, med = median(density))
x.meds <- ddply(wine_red, .(quality.level), summarize, med = median(alcohol))

ggplot( wine_red, aes(x = alcohol, y = density)) + 
  geom_point(alpha = 0.4, aes(color = alcohol.level), size = 2) +
  facet_wrap(~ quality.level) +
  scale_color_brewer(type = 'qual', palette = 6) +
  labs(x = "Alcohol (%vol)", y = "Density (g/cm3)") +
  theme_bw() +
  geom_hline(data = y.meds, aes(yintercept = med), linetype='longdash', color='black', size=0.2) +
  geom_vline(data= x.meds, aes(xintercept = med), linetype='longdash', color='black', size=0.2)


median01 <- median(wine995$total.sulfur.dioxide)
median02 <- median(wine_red$volatile.acidity)

ggplot(wine995, aes(x = total.sulfur.dioxide, y = volatile.acidity)) +
  geom_point(alpha = 0.4, aes(color= quality.level), size = 1.5) +
  scale_color_brewer(type = 'qual', palette = 2) +
  theme_bw() +
  geom_hline(yintercept= median02, linetype="dashed", color='black', size=0.4) +
  geom_vline(xintercept=median01, linetype="dashed", color='black', size=0.4)


#Create lines for the median of volatile acidty and total sulfur dioxide
y.meds <- ddply(wine_red, .(alcohol.level), summarize, med = median(volatile.acidity))
x.meds <- ddply(wine995, .(alcohol.level), summarize, med = median(total.sulfur.dioxide))

ggplot(wine995, aes(x = total.sulfur.dioxide, y = volatile.acidity)) +
  geom_point(alpha = 0.4, aes(color= quality.level), size = 1.5) +
  scale_color_brewer(type = 'qual', palette = 2) +
  facet_wrap(~ alcohol.level) +
  theme_bw() +
  ylim(0.1, 1.2)+
  geom_hline(data = y.meds, aes(yintercept = med), linetype='longdash', color='black', size=0.25) +
  geom_vline(data= x.meds, aes(xintercept = med), linetype='longdash', color='black', size=0.25)

```

The Density vs. Alcohol plot, colored by quality level confirms what we already know: high-quality wines tend to have high levels of alcohol and low densities. There is not a clear pattern that could allow us to identify "zones" mostly populated by single-quality samples. When we faceted this plot by quality and change colors to match the alcohol level, we immediately have a clear view of the sample distributions by alcohol level for each quality level.  

At the beginning of this study, we expected the sulfur dioxide content to be a factor in wine quality, due to its anti-oxidative and anti-microbial properties. What we can see by plotting volatile acidity vs. total sulfur dioxide is that the later could be found in a widespread interval of concentrations and still winemakers managed to obtain medium-quality wines.

```{r echo=FALSE, Multivariate_Plots_04}
median01 = median(wine_red$chlorides)
median02 = median(wine_red$sulphates)

ggplot(wine_red, aes(x = chlorides, y = sulphates, color = quality.level)) +
  geom_point(alpha = 0.4, size = 2.5) +
  scale_color_brewer(type = 'qual', palette = 2) +
  theme_bw() +
  geom_hline(yintercept= median02, linetype="dashed", color='black', size=0.3) +
  geom_vline(xintercept=median01, linetype="dashed", color='black', size=0.3)


# Finding the number of samples for each condition
dat <- nsamples_df(wine_red, 0.35, 1.8, "alcohol.level", "quality.level")

y.meds <- ddply(wine_red, .(alcohol.level, quality.level), summarize, med = median(sulphates))
x.meds <- ddply(wine_red, .(alcohol.level, quality.level), summarize, med = median(chlorides))

ggplot(wine_red, aes(x = chlorides, y = sulphates)) +
  geom_point(alpha = 0.4, size = 2, aes(color = alcohol.level)) +
  scale_color_brewer(type = 'qual', palette = 2) +
  theme_bw() +
  facet_grid(alcohol.level~quality.level) +
  geom_text(aes(x, y, label=count, group=NULL),data=dat) +
  geom_vline(data=x.meds, aes(xintercept=med), linetype='longdash', color='black', size=0.25) +
  geom_hline(data = y.meds, aes(yintercept = med), linetype='longdash', color='black', size=0.25)

```

The plot of sulphates vs. chlorides, colored by quality level (top), shows a "core" of points where all quality levels are included, with scattered points that could be easily treated as outliers and eventually discarded. When we faceted that graph by alcohol level and quality levels (bottom), a slightly different picture arises. It is clear that all those "outliers" occurred for the "Low Alcohol" condition only. They could be still outliers, or a sign that at low levels of alcohol the variables are allowed to change in a wider range. In any case, a more careful look is required.


```{r echo=FALSE, Multivariate_Plots_05}
median01 = median(wine_red$volatile.acidity)
median02 = median(wine_red$density)

plt3.14 <- ggplot(wine_red, aes(x = volatile.acidity, y = density)) +
  geom_point(alpha = 0.5, aes(color= quality.level)) +
  scale_color_brewer(type = 'qual', palette = 6) +
  geom_hline(yintercept= median02, linetype="dashed", color='black', size=0.3) +
  geom_vline(xintercept=median01, linetype="dashed", color='black', size=0.3) +
  theme_bw()
print(plt3.14)

# Finding number of samples for SO2 level
dat <- nsamples_df(wine_red, 1.3, 1.005, "SO2.level")

# Creating median values for density and volatile acidity
y.meds <- ddply(wine_red, .(SO2.level), summarize, med = median(density))
x.meds <- ddply(wine_red, .(SO2.level), summarize, med = median(volatile.acidity))

plt3.15 <- ggplot(wine_red, aes(x = volatile.acidity, y = density)) +
  geom_point(alpha = 0.5, aes(color= quality.level)) +
  facet_wrap(~SO2.level) +
  scale_color_brewer(type = 'qual', palette = 6) +
  geom_hline(data = y.meds, aes(yintercept = med), linetype='longdash', color='black', size=0.25) +
  geom_vline(data= x.meds, aes(xintercept = med), linetype='longdash', color='black', size=0.25) +
  theme_bw() +
  geom_text(aes(x, y, label=count, group=NULL),data=dat)
print(plt3.15)

# Finding number of samples for each condition
dat <- nsamples_df(wine_red, 1.3, 1.002, "alcohol.level", "SO2.level")

#Creating median lines
y.meds <- ddply(wine_red, .(alcohol.level, SO2.level), summarize, med = median(density))
x.meds <- ddply(wine_red, .(alcohol.level, SO2.level), summarize, med = median(volatile.acidity))

ggplot(wine_red, aes(x = volatile.acidity, y = density)) +
  geom_point(alpha = 0.5, aes(color= quality.level)) +
  facet_grid(alcohol.level~SO2.level) +
  scale_color_brewer(type = 'qual', palette = 6) +
  geom_text(aes(x, y, label=count, group=NULL),data=dat) +
  geom_vline(data=x.meds, aes(xintercept=med), linetype='longdash', color='black', size=0.25) +
  geom_hline(data = y.meds, aes(yintercept = med), linetype='longdash', color='black', size=0.25) +
  theme_bw()
```

Small details also contribute to a better understanding of the data. In this case, we plotted density vs. volatile acidity.  From the first graph, it is hard to draw any conclusions other than the data appears to be dispersed without a clear trend. When we faceted it by SO2 levels, it becomes apparent that in average, the density increases with SO2 level, (as expected) and volatile acidity unexpectedly rises as the SO2 levels go from low to high (we noticed it in the comments related to the box plots above). The small detail there is that the dispersion of the data in the vertical axis seems to increase from lower to higher SO2 levels. A second faceting, this time by alcohol level, applied to the previous plot let us dig deeper into the data.  For each SO2 level, there is a distribution of alcohol content in the samples. Those distributions have medians far apart enough to cause dispersion in density. The maximum in the relative amount of samples (within a single SO2 level) shifts from "Medium Alcohol" for "Low SO2"(86/178) to "Low Alcohol"  with a tendency to increase, for the next two levels (522/1169, then 178/252).


```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_PLots_06}
ggplot( wine_red, aes(y = sulphates, x = volatile.acidity)) + 
  geom_point(alpha = 0.5, size = 2, aes(color = quality.level)) +
  ylim(0.4,1) +
  xlim(0.2, 1) +
  scale_color_brewer(type = 'qual', palette = 6) +
  theme_bw()

# Finding number of samples for each condition
dat <- nsamples_df(wine_red, 0.95, 1.4, "quality.level")

# Creating median values for sulphates and volatile acidity
y.meds <- ddply(wine_red, .(quality.level), summarize, med = median(sulphates))
x.meds <- ddply(wine_red, .(quality.level), summarize, med = median(volatile.acidity))

ggplot( wine_red, aes(y = sulphates, x = volatile.acidity)) + 
  geom_point(alpha = 0.3, size = 2, aes(color = quality.level)) +
  ylim(0.3,1.5) +
  xlim(0.2, 1.2) +
  facet_grid(~quality.level) +
  geom_hline(data = y.meds, aes(yintercept = med), linetype='longdash', color='black', size=0.25) +
  geom_vline(data= x.meds, aes(xintercept = med), linetype='longdash', color='black', size=0.25) +
  scale_color_brewer(type = 'qual', palette = 6) +
  geom_text(aes(x, y, label=count, group=NULL),data=dat) +
  theme_bw()
  
```

When we plotted sulphates vs. volatile acidity using color to account for quality levels, we did not observe any trend at first. 
Faceting that plot by quality level allowed us to realize that medians of sulphates and volatile acidity in the "Low" and "High" quality groups of samples were separated enough to be noticed. They were just overshadowed by a cloud of points belonging to intermediate values of quality.

```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots_07}
#Removing quality levels "Medium Low" and "Medium"
wine_ext <- subset(wine_red, quality.level == "High" | quality.level == "Low")

num_samp <- length(wine_ext$sulphates)
samp_lab <- paste("N = ", num_samp)
dat <- data.frame(x=c(1.4), y=c(1.25), label1=c(samp_lab))
  
plt3.30 <- ggplot(wine_ext, aes(x=volatile.acidity, y=sulphates)) +
  geom_point(size = 2.5, alpha = 0.6, aes(color = quality.level)) +
  ylim(0.25,1.4) +
  geom_text(aes(x, y, label=label1, group=NULL), data = dat) +
  scale_color_brewer(type = 'qual', palette = 6) +
  theme_bw() +
  labs(x="volatile acidity (g/L)", y="sulphates (g/L)") +
  ggtitle("Sulphates vs. volatile acidity for reduced data")
  
dat <- nsamples_df(wine_ext, 1, 1.25, "alcohol.level")
plt3.31 <- ggplot(wine_ext, aes(x=volatile.acidity, y=sulphates)) +
  geom_point(size = 2.5, alpha = 0.6, aes(color = quality.level)) +
  ylim(0.25,1.4) +
  geom_text(aes(x, y, label=count, group=NULL),data=dat) +
  scale_color_brewer(type = 'qual', palette = 6) +
  theme_bw()+
  facet_grid(~alcohol.level) +
  labs(x="volatile acidity (g/L)", y="sulphates (g/L)")

grid.arrange(plt3.30, plt3.31, ncol=1)
         
```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

When we split the four stronger correlations across quality levels, we observed that they tend to be more robust as we moved in quality from low to high. The same applies if we substitute quality levels by alcohol levels.  

Density has a strong negative correlation with alcohol. When we plotted density vs. alcohol in a scatter graph, colored by quality level, we acknowledged that a significant part of the "Medium Low" quality samples lies to the left of the alcohol median value. Also,  most of the "High" quality samples are to the right of that median. It is hard to make any statement regarding "Medium" or "Low" samples. When we faceted that plot with quality levels, colored by alcohol level, we can see how the relative composition (regarding alcohol levels) changes across the quality levels. It goes from low-alcohol reach at low quality to low-alcohol depleted at high quality.  The higher relative amount of high-alcohol samples at high quality helps to explain why the median density decreases from low-quality to high-quality wines.

Volatile acidity and total sulfur dioxide are a pair of variables that are not correlated. By plotting a scatter graph of volatile acidity vs. total sulfur dioxide (removing two outliers), colored by quality level, we realized few things. High-quality samples tend to have low values of volatile acidity, low-quality samples show more dispersion in volatile acidity than the rest and medium-low-quality samples are spread all over the total sulfur dioxide axis. The same plot, faceted by alcohol level reveals that low-quality samples, highly dispersed in the total sulfur dioxide axis, dominate the low alcohol level. The "Medium Alcohol" level contains proportionally more high-quality samples, pushing the median volatile acidity to lower values. At the "High Alcohol" level, there are almost exclusively medium and high-quality samples, which lowers the median volatile acidity even further.  Red wines with "High Alcohol"  are characterized by relatively low dispersion and low median values of volatile acidity and total sulfur dioxide. That is something good since volatile acidity is linked to the vinegary taste and high levels of total sulfur dioxide have a bad influence on taste as well.

### Were there any interesting or surprising interactions between features?

The sulfates vs. chlorides scatter graph shows dispersion in both axes and giving color to the samples by quality does not help to understand what is going on. When this plot is faceted by quality levels and alcohol levels it becomes clear that the issue occurs exclusively with low alcohol samples.

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.


We resisted the temptation of creating a new variable named "total acidity" by adding up "fixed.acidity", "volatile.acidity", and "citric.acid". A closer look at the variables makes clear that they are expressed as different acids. Unfortunately, even by doing that correctly with the intention of creating a model to predict the pH values based on total acidity (and using a simple equilibrium constant model), our predicted pH values were off by 0.3 to 0.9 pH units.  For that reason, we decided to exclude it from this work.


# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}
ggplot(wine_red, aes(x = quality, fill = alcohol.level)) + 
  geom_bar(position = "dodge") +
  theme_bw() +
  ggtitle("Alcohol level distribution by quality")
```

### Description One

The bar plot displays the composition of our dataset regarding quality and alcohol levels. It does not only show that quality 5 and 6 are the most populated but also that the number of low alcohol samples peaks at quality equals to 5, medium alcohol peaks at 6 and high alcohol does it at 7. The relative composition of alcohol levels within a single quality value changes. At low values of quality (less than or equal to 5) samples with low alcohol dominate, at quality equals to 6 "Medium Alcohol" samples are the most common and finally the composition shifts towards "High Alcohol" at 7.  
We chose the "quality.level" variable in such a way that it is consistent with this graph. We merged samples from qualities 3 and 4 to create the level "Low," and those from quality 7 and 8 to create "High."  We decided to leave 5 and 6 as independent levels ("Medium Low" and "Medium," respectively) mainly because they have different alcohol level compositions.   
According to this graph high quality is associated with high concentration of alcohol in wines.

### Plot Two
```{r echo=FALSE, Plot_Two}
p1 <- ggplot( wine_red, aes(x = quality, y = citric.acid, fill=quality.level)) + 
  geom_boxplot() +
  theme_bw() +
  labs(y = "citric acid (g/L)")
p2 <- ggplot( wine_red, aes(x = quality, y = volatile.acidity, fill=quality.level)) +
  geom_boxplot() +
  theme_bw() +
  labs(y = "volatile acidity (g/L)")
p3 <- ggplot( wine_red, aes(x = quality, y = sulphates, fill=quality.level)) + 
  geom_boxplot() +
  theme_bw() +
  labs(y = "sulphates (g/L)")
p4 <- ggplot( wine_red, aes(x = quality, y = density, fill=quality.level)) + 
  geom_boxplot() +
  theme_bw() +
  labs(y = "density (g/cm3)")
grid.arrange(p1, p2, p3, p4, ncol=2)
```

### Description Two


Although alcohol seems to be relevant to wine quality; other variables also change through all the quality range. In the figure above we chose four of them: citric acid, volatile acidity, sulfates and density. They all have monotonic trends with quality, and while citric acid and sulfates increase, volatile acidity and density do the opposite as quality goes from 3 to 8. 
Citric acid is a weak organic acid; its addition helps by chelating metal ions to prevent browning, increasing the acidity in the process. Too much citric acid affects the taste of red wines negatively and causes microbial instabilities since bacteria use citric acid in their metabolism.  
Volatile acidity is mostly due to the presence of acetic acid in wines. It is responsible for the vinegary odor and taste. For that reason, it is not a surprise that there is a decreasing trend between volatile acidity and quality.
Wine is water, for the most part. That explains why its density is close to 1 g/cm3.  The presence of alcohol makes wine density lower. As the alcohol % vol increases with quality, we expect a decrasing in wine density as quality rises. In a simple water-ethanol solution a 10 % vol alcohol concentration (which is typical for wines) would lead to a density of about 0.97 g/cm3. What we observe in our data are higher values of density, so there are other components of wine also playing a role. The final resul is a slim density interval.
One of the known sulfates (or sulphates in British English) used in wines is cupper sulfate. It is a fining agent, used to remove unpleasant aromas in wine, particularly those related to hydrogen sulfide (rotten-egg-like off aromas). That  explains, at least in part, the positive correlation between sulphates and quality.

### Plot Three
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Three}
num_samp <- length(wine_ext$sulphates)
samp_lab <- paste("N = ", num_samp)
dat <- data.frame(x=c(1.4), y=c(1.25), label1=c(samp_lab))
  
plt3.30 <- ggplot(wine_ext, aes(x=volatile.acidity, y=sulphates)) +
  geom_point(size = 2.5, alpha = 0.6, aes(color = quality.level)) +
  ylim(0.25,1.4) +
  geom_text(aes(x, y, label=label1, group=NULL), data = dat) +
  scale_color_brewer(type = 'qual', palette = 6) +
  theme_bw() +
  labs(x="volatile acidity (g/L)", y="sulphates (g/L)") +
  ggtitle("Sulphates vs. volatile acidity for reduced data")
  
dat <- nsamples_df(wine_ext, 1, 1.25, "alcohol.level")
plt3.31 <- ggplot(wine_ext, aes(x=volatile.acidity, y=sulphates)) +
  geom_point(size = 2.5, alpha = 0.6, aes(color = quality.level)) +
  ylim(0.25,1.4) +
  geom_text(aes(x, y, label=count, group=NULL),data=dat) +
  scale_color_brewer(type = 'qual', palette = 6) +
  theme_bw()+
  facet_grid(~alcohol.level) +
  labs(x="volatile acidity (g/L)", y="sulphates (g/L)")

grid.arrange(plt3.30, plt3.31, ncol=1)
         
```

### Description Three

After plotting some data, it seems like variables belonging to samples with qualities 5 and 6 are dispersed throughout the entire range. It makes near impossible to find clean areas in a two variables space (not involving a quality variable) where clear boundaries between quality levels exist. It appears that, after centuries of wine mass production,  winemakers at Minho province (Portugal) have found a safety range of values for the variables under consideration that allows them to produce a significant percentage of medium qualities (5-6) red wines. We decided then to explore what happens to just the extreme levels ("Low" and "High" quality). 
In the figure above we eliminated data points from quality levels 5 and 6. We plotted sulphates vs. volatile acidity (top), and then faceted by alcohol levels (bottom). 

We observed some regularities:

- The data points are segregated by quality; low-quality points tend to have low values of sulfates and high values of volatile acidity. The opposite occurs for high-quality data with little overlap.

- The dispersion decreases as the alcohol level increases, consistently with some trends in the general data. 

- The relative amount of samples also changed from a low-quality majority at "Low Alcohol" to almost all "high-quality" at "High Alcohol."

# Reflection

Assigning a quality number to wine relies entirely on the human taste in all its subjectivity realm. Throughout this study, we tried to identify variables and conditions that could help us rationalizing what remains otherwise more an art than a science.
We found that in average, alcohol and sulfates have a positive influence on wine quality meanwhile volatile acidity has an adverse impact on it. We also noticed after some search that there is at least one configuration of three variables that could potentially improve the overall quality of the batches by minimizing low-quality wines. 
In the future, it could be interesting continuing the exploration in that direction. We acknowledge that the small amount of data could be a serious drawback. 


## References

[1] P.Cortez, A.Cerdeira, F. Almeida, T. Matos and J. Reis, "Modeling wine preferences by data mining from physicochemical properties" Decision Support Systems, 47(4), 2009, 547-553, ISSN: 0167-9236.

